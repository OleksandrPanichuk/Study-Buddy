// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client"
  output          = "../libs/prisma/src/generated"
  moduleFormat    = "cjs"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector]
}

// Enums

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}

enum FileStatus {
  UPLOADING
  PROCESSING
  READY
  FAILED
}

enum AttachmentScope {
  MESSAGE
  CHAT_CONTEXT
}

enum MaterialType {
  FILE
  NOTE
  QUIZ
  FLASHCARD_DECK
  LESSON
  CODE_LAB
}

// Models

model File {
  id String @id @default(uuid()) @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")
  url       String
  key       String?

  users User[]

  @@map("files")
}

model User {
  id            String  @id @default(uuid()) @db.Uuid
  email         String  @unique
  emailVerified Boolean @default(false) @map("email_verified")
  username      String  @unique
  hash          String?

  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")

  avatarId String? @map("avatar_id") @db.Uuid
  avatar   File?   @relation(references: [id], fields: [avatarId], onDelete: SetNull)

  verificationCodes   VerificationCode[]
  resetPasswordTokens ResetPasswordToken[]

  tutorChats       TutorChat[]
  messages         Message[]
  files            FileAsset[]
  materials        Material[]
  quizResults      QuizResult[]
  flashcardReviews FlashcardReview[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model VerificationCode {
  id String @id @default(uuid()) @db.Uuid

  code String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @map("user_id") @db.Uuid

  resendCount Int      @default(0) @map("resend_count")
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("verification_codes")
}

model ResetPasswordToken {
  id String @id @default(uuid()) @db.Uuid

  token String @unique

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @map("user_id") @db.Uuid

  resendCount Int @default(0) @map("resend_count")

  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  lastSentAt DateTime @default(now()) @map("last_sent_at")

  @@map("reset_password_tokens")
}

model TutorChat {
  id String @id @default(uuid()) @db.Uuid

  name        String  @db.VarChar(60)
  description String? @db.Text
  topic       String? @db.VarChar(60)
  prompt      String  @default("You are a helpful and knowledgeable tutor. Provide clear and concise explanations to help the student understand the topic at hand.") @db.Text

  messages      Message[]
  contextFiles  ChatContextFile[]
  materials     Material[]
  chatSummaries ChatSummary[]

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @map("user_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("tutor_chats")
}

model Message {
  id String @id @default(uuid()) @db.Uuid

  role         MessageRole @default(USER)
  content      String      @db.Text
  model        String?
  inputTokens  Int?        @map("input_tokens")
  outputTokens Int?        @map("output_tokens")
  latencyMs    Int?        @map("latency_ms")

  attachments MessageAttachment[]

  tutorChat   TutorChat @relation(fields: [tutorChatId], references: [id], onDelete: Cascade)
  tutorChatId String    @map("tutor_chat_id") @db.Uuid

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @map("user_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tutorChatId, userId])
  @@map("messages")
}

model MessageAttachment {
  id    String          @id @default(uuid()) @db.Uuid
  scope AttachmentScope @default(MESSAGE)

  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId String  @map("message_id") @db.Uuid

  file   FileAsset @relation(fields: [fileId], references: [id], onDelete: Cascade)
  fileId String    @map("file_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")

  @@index([messageId])
  @@map("message_attachments")
}

model ChatContextFile {
  id       String  @id @default(uuid()) @db.Uuid
  priority Int     @default(0)
  note     String? @db.Text

  tutorChat   TutorChat @relation(fields: [tutorChatId], references: [id], onDelete: Cascade)
  tutorChatId String    @map("tutor_chat_id") @db.Uuid

  file   FileAsset @relation(fields: [fileId], references: [id], onDelete: Cascade)
  fileId String    @map("file_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([tutorChatId, fileId])
  @@map("context_files")
}

model ChatSummary {
  id String @id @default(uuid()) @db.Uuid

  summary    String @db.Text
  tokenCount Int?   @map("token_count")

  tutorChat   TutorChat @relation(fields: [tutorChatId], references: [id], onDelete: Cascade)
  tutorChatId String    @map("tutor_chat_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")

  @@index([tutorChatId])
  @@map("chat_summaries")
}

model FileAsset {
  id         String     @id @default(uuid()) @db.Uuid
  name       String
  mimeType   String     @map("mime_type")
  sizeBytes  Int        @map("size_bytes")
  url        String
  storageKey String?    @map("storage_key")
  status     FileStatus @default(UPLOADING)
  textHash   String?    @map("text_hash")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.Uuid @map("user_id")

  chunks      FileChunk[]
  attachments MessageAttachment[]
  contextRefs ChatContextFile[]
  materials   Material[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("file_assets")
}

model FileChunk {
  id         String                      @id @default(uuid()) @db.Uuid
  index      Int
  content    String                      @db.Text
  tokenCount Int                         @map("token_count")
  embedding  Unsupported("vector(768)")?

  file   FileAsset @relation(fields: [fileId], references: [id], onDelete: Cascade)
  fileId String    @db.Uuid @map("file_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([fileId])
  @@map("file_chunks")
}

model Material {
  id      String       @id @default(uuid()) @db.Uuid
  type    MaterialType
  title   String
  summary String?      @db.Text

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.Uuid

  tutorChat   TutorChat? @relation(fields: [tutorChatId], references: [id], onDelete: SetNull)
  tutorChatId String?    @db.Uuid

  file   FileAsset? @relation(fields: [fileId], references: [id], onDelete: SetNull)
  fileId String?    @db.Uuid

  note Note?
  quiz Quiz?
  deck FlashcardDeck?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, tutorChatId])
  @@map("materials")
}

model Note {
  id      String @id @default(uuid()) @db.Uuid
  content String @db.Text

  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  materialId String   @unique @db.Uuid @map("material_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("notes")
}

model Quiz {
  id         String  @id @default(uuid()) @db.Uuid
  difficulty String?

  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  materialId String   @unique @db.Uuid @map("material_id")

  questions QuizQuestion[]
  results   QuizResult[]

  createdAt DateTime @default(now()) @map("created_at")

  @@map("quizzes")
}

model QuizQuestion {
  id      String @id @default(uuid()) @db.Uuid
  prompt  String @db.Text
  type    String
  options Json?
  answer  Json?

  quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId String @db.Uuid @map("quiz_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("quiz_questions")
}

model QuizResult {
  id      String @id @default(uuid()) @db.Uuid
  score   Int
  total   Int
  answers Json?

  quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId String @db.Uuid @map("quiz_id")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.Uuid @map("user_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, quizId])
  @@map("quiz_results")
}

model FlashcardDeck {
  id String @id @default(uuid()) @db.Uuid

  material   Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  materialId String   @unique @db.Uuid @map("material_id")

  cards Flashcard[]

  createdAt DateTime @default(now()) @map("created_at")

  @@map("flashcard_decks")
}

model Flashcard {
  id    String @id @default(uuid()) @db.Uuid
  front String @db.Text
  back  String @db.Text

  deck   FlashcardDeck @relation(fields: [deckId], references: [id], onDelete: Cascade)
  deckId String        @db.Uuid @map("deck_id")

  reviews FlashcardReview[]

  createdAt DateTime @default(now()) @map("created_at")

  @@map("flashcards")
}

model FlashcardReview {
  id         String   @id @default(uuid()) @db.Uuid
  easeFactor Float    @map("ease_factor")
  interval   Int
  nextReview DateTime @map("next_review")

  card   Flashcard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  cardId String    @db.Uuid @map("card_id")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.Uuid @map("user_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId, cardId])
  @@map("flashcard_reviews")
}
